<!DOCTYPE html>
<html>
  <head>
    <title>
      Take or select photo(s) and upload
    </title>

    <script src="demo/jquery-1.8.3.min.js"></script>
    <script src="build/convnet.js"></script>
    <script type="text/javascript">   

      var classes_txt = ['ducky', 'hawaii', 'kid', 'maid', 'santa', 'stash'];
      layer_defs = [];
      layer_defs.push({type:'input', out_sx:32, out_sy:64, out_depth:3});
      layer_defs.push({type:'conv', sx:5, filters:16, stride:1, pad:2, activation:'relu'});
      layer_defs.push({type:'pool', sx:2, stride:2});
      layer_defs.push({type:'conv', sx:5, filters:20, stride:1, pad:2, activation:'relu'});
      layer_defs.push({type:'pool', sx:2, stride:2});
      layer_defs.push({type:'conv', sx:5, filters:20, stride:1, pad:2, activation:'relu'});
      layer_defs.push({type:'pool', sx:2, stride:2});
      layer_defs.push({type:'softmax', num_classes:6});

      net = new convnetjs.Net();
      net.makeLayers(layer_defs);

      trainer = new convnetjs.SGDTrainer(net, {method:'adadelta', batch_size:4, l2_decay:0.0001});
      load_pretrained();



      function load_pretrained() {
        $.getJSON("demo/cifarChiquita_snapshot.json", function(json){
          net = new convnetjs.Net();
          net.fromJSON(json);
          trainer.learning_rate = 0.0001;
          trainer.momentum = 0.9;
          trainer.batch_size = 2;
          trainer.l2_decay = 0.00001;
        });
      }

      function fileSelected() {
        var count = document.getElementById('fileToUpload').files.length;
        document.getElementById('details').innerHTML = "";
        for (var index = 0; index < count; index ++)        
        {
          var file = document.getElementById('fileToUpload').files[index];
          var fileSize = 0;
          if (file.size > 1024 * 1024)          
            fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
          else         
            fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
          document.getElementById('details').innerHTML += 'Name: ' + file.name + '<br>Size: ' + fileSize + '<br>Type: ' + file.type;
          document.getElementById('details').innerHTML += '<p>';
        }
        
        var file = document.getElementById('fileToUpload').files[0];
        drawOnCanvas(file);
        // see Example 6
        //        displayAsImage(file); // see Example 7
      }
      
      function uploadFile() {
        var fd = new FormData();
        var count = document.getElementById('fileToUpload').files.length;
        for (var index = 0; index < count; index ++)
        {
          var file = document.getElementById('fileToUpload').files[index];
          fd.append(file.name, file);
        }
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener("progress", uploadProgress, false);
        xhr.addEventListener("load", uploadComplete, false);
        xhr.addEventListener("error", uploadFailed, false);
        xhr.addEventListener("abort", uploadCanceled, false);
        xhr.open("POST", "savetofile.aspx");
        xhr.send(fd);
      }
      
      function uploadProgress(evt) {
        if (evt.lengthComputable) {
          var percentComplete = Math.round(evt.loaded * 100 / evt.total);
          document.getElementById('progress').innerHTML = percentComplete.toString() + '%';
        }
        else {
          document.getElementById('progress').innerHTML = 'unable to compute';
        }
      }
      
      function uploadComplete(evt) {
        /* This event is raised when the server send back a response */
        alert(evt.target.responseText);
      }
      
      function uploadFailed(evt) {
        alert("There was an error attempting to upload the file.");
      }
      
      function uploadCanceled(evt) {
        alert("The upload has been canceled by the user or the browser dropped the connection.");
      }
      
      function drawOnCanvas(file) {
        var reader = new FileReader();
        
        reader.onload = function (e) {
          var dataURL = e.target.result,
              c = document.querySelector('canvas'), // see Example 4
              ctx = c.getContext('2d'),
              img = new Image();
          img.onload = function() {
            //      c.width = img.width;
            //     c.height = img.height;
            document.getElementById('details').innerHTML += 'width: ' + img.width + '<br>';
            document.getElementById('details').innerHTML += 'height: ' + img.height + '<br>';
            
            var maxLength = img.width > img.height? img.width:img.height;
            var rescaleFactor = Math.round(maxLength / 200);
            if (rescaleFactor < 1) {
              rescaleFactor = 1;
            }
            var resizedWidth = img.width/rescaleFactor;
            var resizedHeight = img.height/rescaleFactor;

            ctx.drawImage(img, 0, 0, width=resizedWidth, height=resizedHeight);
            var img_data = ctx.getImageData(0, 0, resizedWidth, resizedHeight);
 //           displayAsCanvas(img_data);

            document.getElementById('details').innerHTML += 'DataSize: ' + img_data.width + 'x' + img_data.height + '<p>';
            var p = img_data.data;
            var W = resizedWidth*resizedHeight;
            var rawData = new Float32Array(W*3);
            for(var dc=0;dc<3;dc++) {
              var i=0;
              for(var yc=0;yc<resizedHeight;yc++) {
                for(var xc=0;xc<resizedWidth;xc++) {               
                  var ix = i++ * 4 + dc;
                  var rawIndex = ((yc * resizedWidth + xc) * 3)+ dc;
                  rawData[rawIndex] = p[ix]/255.0-0.5; 
                }
              }
            }
            generateSubImagesAsCanvas(ctx, resizedWidth, resizedHeight, 32, 64, 5);
            result = imageMatch(rawData, resizedWidth, resizedHeight);
          };
          
          img.src = dataURL;
        };
        
        reader.readAsDataURL(file);
      }

      function imageMatch(rawData, srcWidth, srcHeight) {
        var num_classes = net.layers[net.layers.length-1].out_depth;
        // forward prop it through the network
        var aavg = new convnetjs.Vol(1,1,num_classes,0.0);
        // ensures we always have a list, regardless if above returns single item or list
        var xs = sample_test_instance(rawData, srcWidth, srcHeight, 0, 0);
        var n = xs.length;
        for(var i=0;i<n;i++) {
          var a = net.forward(xs[i]);
          aavg.addFrom(a);
        }

        return null;
      }

      // sample an area 
      var sample_test_instance = function(rawData, srcWidth, srcHeight, startX, startY) {
        var x = new convnetjs.Vol(32,64,3,0.0);
        var W = srcWidth * 3;
        for(var yc=0;yc<64;yc++) {
          for(var xc=0;xc<32;xc++) {
            for(var dc=0;dc<3;dc++) {
              var ix = ((srcWidth*yc + xc) * 3) + dc;
              x.set(xc,yc,dc,rawData[ix]);
            }
          }
        }

        // distort position and maybe flip
        var xs = [];
        xs.push(x); // push an un-augmented copy
        
        // return multiple augmentations, and we will average the network over them
        // to increase performance
        return xs;
      }

      function generateSubImagesAsCanvas(ctx, srcWidth, srcHeight, croppedWidth, croppedHeight, strideLength) {
        for (var yOffset = 0; yOffset+croppedHeight < srcHeight; yOffset+=strideLength) {
          for(var xOffset = 0; xOffset+croppedWidth < srcWidth; xOffset+=strideLength) {
            var imageData = ctx.getImageData(xOffset, yOffset, croppedWidth, croppedHeight);
            displayAsCanvas(imageData, croppedWidth, croppedHeight, strideLength);
          }
          document.body.appendChild(document.createElement("br"));
        }
      }

      function displayAsCanvas(imageData, width, height, padding) {
        var aCanvas = document.createElement('canvas');
        aCanvas.width = width;
        aCanvas.height = height;
        aCanvas.padding = padding;
        var ctx = aCanvas.getContext('2d');
        ctx.putImageData(imageData, 0, 0);
        document.body.appendChild(aCanvas);
      }

      
    </script>
  </head>
  <body>
    <form id="form1" enctype="multipart/form-data" method="post" action="Upload.aspx">
      <div>
        <label for="fileToUpload">
          Take or select photo(s)
        </label>
        <br />
        <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();" accept="image/*" capture="camera" />
        <br />
        <canvas>
        </canvas>
      </div>
      <div id="details">
      </div>
      <div id="progress">
      </div>
    </form>
  </body>
</html>