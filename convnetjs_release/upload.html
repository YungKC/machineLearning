<!DOCTYPE html>
<html>
<head>
  <title>
    Take or select photo(s) and upload
  </title>

  <script src="demo/jquery-1.8.3.min.js"></script>
  <script src="exif.js" type="text/javascript"></script>
  <script src="build/convnet.js"></script>
  <script type="text/javascript">   

  var classes_txt = ['ducky', 'hawaii', 'kid', 'maid', 'santa', 'stash', 'notFound'];
  var net = new convnetjs.Net();
  load_pretrained();

  function load_pretrained() {
      $.getJSON("demo/cifarChiquita_snapshot.json", function(json) {
          net = new convnetjs.Net();
          net.fromJSON(json);
          trainer.learning_rate = 0.0001;
          trainer.momentum = 0.9;
          trainer.batch_size = 2;
          trainer.l2_decay = 0.00001;
      });
  }

  function fileSelected() {
      var count = document.getElementById('fileToUpload').files.length;
      document.getElementById('details').innerHTML = "";
      for (var index = 0; index < count; index++) {
          var file = document.getElementById('fileToUpload').files[index];
          var fileSize = 0;
          if (file.size > 1024 * 1024)
              fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
          else
              fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
          document.getElementById('details').innerHTML += 'Name: ' + file.name + '<br>Size: ' + fileSize + '<br>Type: ' + file.type;
          document.getElementById('details').innerHTML += '<p>';
      }

      var file = document.getElementById('fileToUpload').files[0];
      drawOnCanvas(file);
      // see Example 6
      //        displayAsImage(file); // see Example 7
  }

  function uploadFile() {
      var fd = new FormData();
      var count = document.getElementById('fileToUpload').files.length;
      for (var index = 0; index < count; index++) {
          var file = document.getElementById('fileToUpload').files[index];
          fd.append(file.name, file);
      }
      var xhr = new XMLHttpRequest();
      xhr.upload.addEventListener("progress", uploadProgress, false);
      xhr.addEventListener("load", uploadComplete, false);
      xhr.addEventListener("error", uploadFailed, false);
      xhr.addEventListener("abort", uploadCanceled, false);
      xhr.open("POST", "savetofile.aspx");
      xhr.send(fd);
  }

  function uploadProgress(evt) {
      if (evt.lengthComputable) {
          var percentComplete = Math.round(evt.loaded * 100 / evt.total);
          document.getElementById('progress').innerHTML = percentComplete.toString() + '%';
      } else {
          document.getElementById('progress').innerHTML = 'unable to compute';
      }
  }

  function uploadComplete(evt) {
      /* This event is raised when the server send back a response */
      alert(evt.target.responseText);
  }

  function uploadFailed(evt) {
      alert("There was an error attempting to upload the file.");
  }

  function uploadCanceled(evt) {
      alert("The upload has been canceled by the user or the browser dropped the connection.");
  }

  function drawOnCanvas(file) {
      var reader = new FileReader();

      reader.onload = function(e) {
          var dataURL = e.target.result,
              c = document.querySelector('canvas'),
              ctx = c.getContext('2d'),
              img = new Image();
          img.onload = function() {

              var width;
              var height;

              var exif, transform = "none";
              EXIF.getData(img, function() {
                  exif = this.exifdata;
                  alert(EXIF.pretty(this));
                  if (exif.Orientation === 8) {
                      width = img.height;
                      height = img.width;
                      transform = "left";
                  } else if (exif.Orientation === 6) {
                      width = img.height;
                      height = img.width;
                      transform = "right";
                  } else if (exif.Orientation === 1) {
                      width = img.width;
                      height = img.height;
                  } else if (exif.Orientation === 3) {
                      width = img.width;
                      height = img.height;
                      transform = "flip";
                  } else {
                      width = img.width;
                      height = img.height;
                  }
                  var MAX_WIDTH = 100;
                  var MAX_HEIGHT = 100;
                  if (width / MAX_WIDTH > height / MAX_HEIGHT) {
                      if (width > MAX_WIDTH) {
                          height *= MAX_WIDTH / width;
                          width = MAX_WIDTH;
                      }
                  } else {
                      if (height > MAX_HEIGHT) {
                          width *= MAX_HEIGHT / height;
                          height = MAX_HEIGHT;
                      }
                  }

                  width = Math.round(width);
                  height = Math.round(height);
                  c.width = width;
                  c.height = height;
              });

              ctx.fillStyle = 'white';
              ctx.fillRect(0, 0, c.width, c.height);

              if (transform === 'left') {
                  ctx.setTransform(0, -1, 1, 0, 0, height);
                  ctx.drawImage(img, 0, 0, height, width);
              } else if (transform === 'right') {
                  ctx.setTransform(0, 1, -1, 0, width, 0);
                  ctx.drawImage(img, 0, 0, height, width);
              } else if (transform === 'flip') {
                  ctx.setTransform(1, 0, 0, -1, 0, height);
                  ctx.drawImage(img, 0, 0, width, height);
              } else {
                  ctx.setTransform(1, 0, 0, 1, 0, 0);
                  ctx.drawImage(img, 0, 0, width, height);
              }
              ctx.setTransform(1, 0, 0, 1, 0, 0);


              var img_data = ctx.getImageData(0, 0, width, height);
              var p = img_data.data;

              document.getElementById('details').innerHTML += 'width: ' + width + '<br>';
              document.getElementById('details').innerHTML += 'height: ' + height + '<br>';
              document.getElementById('details').innerHTML += 'DataSize: ' + img_data.width + 'x' + img_data.height + '<p>';




              var W = width * height;
              var rawData = new Float32Array(W * 3);
              for (var dc = 0; dc < 3; dc++) {
                  var i = 0;
                  for (var yc = 0; yc < height; yc++) {
                      for (var xc = 0; xc < width; xc++) {
                          var ix = i++ * 4 + dc;
                          var rawIndex = ((yc * width + xc) * 3) + dc;
                          rawData[rawIndex] = p[ix] / 255.0 - 0.5;
                      }
                  }
              }
              generateSubImagesAsCanvas(ctx, width, height, 32, 64, 4);
              result = imageMatch(rawData, width, height);
              var newResult = matchedObject(rawData, width, height, 32, 64, 4)
          };

          img.src = dataURL;
      };

      reader.readAsDataURL(file);
  }

  function imageMatch(rawData, srcWidth, srcHeight) {
      var num_classes = net.layers[net.layers.length - 1].out_depth;
      // forward prop it through the network
      var aavg = new convnetjs.Vol(1, 1, num_classes, 0.0);
      // ensures we always have a list, regardless if above returns single item or list
      var xs = sample_test_instance(rawData, srcWidth, srcHeight, 0, 0);
      var n = xs.length;
      for (var i = 0; i < n; i++) {
          var a = net.forward(xs[i]);
          aavg.addFrom(a);
      }

      return null;
  }



  var matchedObject = function(rawData, srcWidth, srcHeight, windowWidth, windowHeight, stride) {

      var processingStatus = '';

      function updateProgress() {
        document.getElementById('details').innerHTML = processingStatus;
        iID = setTimeout(updateProgress, 1000);
      }

      var iID = setTimeout(updateProgress, 0);

      var num_classes = net.layers[net.layers.length - 1].out_depth;
      var notFoundType = num_classes - 1;

      var xLoc = 0,
          yLoc = 0,
          matchedType = notFoundType,
          maxProb = -1;

      for (var y = 0; y + windowHeight <= srcHeight; y += stride) {
        for (var x = 0; x + windowWidth <= srcWidth; x += stride) {
            // if  (x==20 && y==24) {
            //   alert("here");
            // }
          processingStatus += '<br>Processing at (' + x + ', ' + y + ')... ';
          var xs = sample_test_instance(rawData, srcWidth, srcHeight, x, y);
          var a = net.forward(xs[0]);

          var foundType = -1;
          var typeProb = -1;
          for (var typeID = 0; typeID < num_classes; typeID++) {
              if (a.w[typeID] > typeProb) {
                  foundType = typeID;
                  typeProb = a.w[typeID];
              }
          }
          if (typeProb > maxProb && foundType != notFoundType) {
              maxProb = typeProb;
              matchedType = foundType;
              xLoc = x;
              yLoc = y;
              processingStatus += '<br>Found at (' + x + ', ' + y + '): ' + classes_txt[matchedType] + ' : ' + maxProb;
          }
        }
      };
      if (matchedType != notFoundType) {
          alert('Found ' + classes_txt[matchedType] + ' at (' + xLoc + ', ' + yLoc + ') with confidence of ' + maxProb);
      } else {
          alert('Not Found!');
      }
      clearTimeout(iID);
      document.getElementById('details').innerHTML = processingStatus;
      return {
          x: xLoc,
          y: yLoc,
          matchedType: matchedType,
          matchedProb: maxProb
      };
  }

  // sample an area 
  var sample_test_instance = function(rawData, srcWidth, srcHeight, startX, startY) {
      var x = new convnetjs.Vol(32, 64, 3, 0.0);
      var W = srcWidth * 3;
      for (var yc = 0; yc < 64; yc++) {
          for (var xc = 0; xc < 32; xc++) {
              for (var dc = 0; dc < 3; dc++) {
                  var ix = ((srcWidth * (yc + startY) + (xc + startX)) * 3) + dc;
                  x.set(xc, yc, dc, rawData[ix]);
              }
          }
      }

      var xs = [];
      xs.push(x); // push an un-augmented copy

      // return multiple augmentations, and we will average the network over them
      // to increase performance
      return xs;
  }

  function generateSubImagesAsCanvas(ctx, srcWidth, srcHeight, croppedWidth, croppedHeight, strideLength) {
      for (var yOffset = 0; yOffset + croppedHeight <= srcHeight; yOffset += strideLength) {
          for (var xOffset = 0; xOffset + croppedWidth <= srcWidth; xOffset += strideLength) {
              var imageData = ctx.getImageData(xOffset, yOffset, croppedWidth, croppedHeight);
              displayAsCanvas(imageData, croppedWidth, croppedHeight, strideLength);
          }
          document.body.appendChild(document.createElement("br"));
      }
  }

  function displayAsCanvas(imageData, width, height, padding) {
      var aCanvas = document.createElement('canvas');
      aCanvas.width = width;
      aCanvas.height = height;
      aCanvas.padding = padding;
      var ctx = aCanvas.getContext('2d');
      ctx.putImageData(imageData, 0, 0);
      document.body.appendChild(aCanvas);
  }
        
  </script>
</head>
<body>
  <form id="form1" enctype="multipart/form-data" method="post" action="Upload.aspx">
    <div>
      <label for="fileToUpload">
        Take or select photo(s)
      </label>
      <br />
      <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();" accept="image/*" capture="camera" />
      <br />
      <canvas width=100 height=100>
      </canvas>
    </div>
    <div id="details">
    </div>
    <div id="progress">
    </div>
  </form>
</body>
</html>